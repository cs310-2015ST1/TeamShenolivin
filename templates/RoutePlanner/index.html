<!DOCTYPE html>
{% load staticfiles %}
<html>
    <head>
        <title>MegaByke Route Planner</title>
        <script src="http://maps.googleapis.com/maps/api/js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="{%  static "js/bikeWayPlotter.js" %}"></script>
        <script src="{%  static "js/mainScript.js" %}"></script>
        <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans" />
        <link rel="stylesheet" type="text/css" href="{% static "css/htmlStyle.css" %}" />
        <input type="hidden" id="dallBikeWays" name="variable" value="{{ allBikeWays }}">
        <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=places"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js" type="text/javascript"></script>
        <script type="text/javascript">
            var loggedIn = false;
            var times = 0;
            var inputLocations = [];
            var directionsDisplay;
            var stepDisplay;
            var directionsService = new google.maps.DirectionsService();
            var map;
            var stepDisplay;
            var markerArray = [];

            function greyOut(inputLocations, i) {
                console.log("Executing input change callback");
                var place = inputLocations[i].searchBox.getPlace();
                console.log(inputLocations[i].searchBox.getPlace());
                var locationString = document.getElementById("locationInput" + (i+1).toString()).value;
                                  
                if (place == null && locationString === "") {
                    if (i < 4) {
                        document.getElementById("locationInput"+(i+2).toString()).disabled = true;
                        document.getElementById("delete"+(i+2).toString()).disabled = true;
                        document.getElementById("locationInput"+(i+2).toString()).style.backgroundColor = '#CCCCCC';
                    }
                    return false;
                } else {
                    if (i < 4) {
                        document.getElementById("locationInput"+(i+2).toString()).disabled = false;
                        document.getElementById("delete"+(i+2).toString()).disabled = false;
                        document.getElementById("locationInput"+(i+2).toString()).style.backgroundColor = '#FFFFFF';
                    }
                }
                return true;
            }
                
            function initialize() {
                directionsDisplay = new google.maps.DirectionsRenderer();
                // map setup
                var mapProp = {
                    center:new google.maps.LatLng(49.2827,-123.1207),
                    zoom:12,
                    mapTypeId:google.maps.MapTypeId.ROADMAP
                };
                
                map = new google.maps.Map(document.getElementById("googleMap"),mapProp);
                directionsDisplay.setMap(map);
                stepDisplay = new google.maps.InfoWindow();
                var allBikeWays = {{ allBikeWays }};
                for (var i = 0; i < allBikeWays.length; i++) {
                    plotBikeWay(allBikeWays[i], map);
                }
                
                // setting up the search boxes
                var inputBoxes = document.querySelectorAll("input[type=text]");
                console.log(inputBoxes.length);
                
                for (var i = 0; i < inputBoxes.length; i++) {
                    
                    console.log("Found " + inputBoxes[i].id);
                    
                    // make a struct of related data for each input box
                    // save all the information in an array of structs
                    inputLocations[i] = { 
                        element: inputBoxes[i], 
                    
                        marker: new google.maps.Marker({
                            map: map,
                            anchorPoint: new google.maps.Point(0, -29)
                        }),

                        searchBox: new google.maps.places.Autocomplete(/** @type {HTMLInputElement} */(inputBoxes[i])),

                        markerIcon: "{{ STATIC_URL }}images/marker" + (i+1).toString() + ".png"
                    };
                
                    console.log(inputLocations[i].markerIcon);
                    inputLocations[i].marker.setVisible(false);
                    
                    // document.getElementById("locationInput"+(i+1).toString()).value = "";

                    // create the listener for when the text box is updated
                    google.maps.event.addListener(inputLocations[i].searchBox, 'place_changed', function() {
                                                  
                        var bounds = new google.maps.LatLngBounds();
                        var invalidLocations = [];
                        var numMarkers = 0;
                        // disabling and enabling input text boxes
                        for (var i = 0; i < inputLocations.length; i++) {
                            var place = inputLocations[i].searchBox.getPlace();
                            
                            if (!greyOut(inputLocations, i)) {
                                continue;
                            }
                            inputLocations[i].marker.setVisible(false);

                            // Create a marker if the location can be found
                            if (typeof place == "undefined") {
                                continue;
                            }
                            if (place.geometry == null) {
                                invalidLocations.push(place.name); 
                                console.log("invalid location: " + place.name);
                                continue;
                            }
                        
                            inputLocations[i].marker = new google.maps.Marker({
                                map: map,
                                //icon: 'http://maps.google.com/mapfiles/marker.png',
                                icon: inputLocations[i].markerIcon,
                                title: place.name,
                                position: place.geometry.location
                            });

                            inputLocations[i].marker.setVisible(true);
                            numMarkers++;
                            bounds.extend(place.geometry.location);
                        }

                        if (invalidLocations.length > 0) {
                            var errMsg = invalidLocations.length > 1 ? "Locations ":"Location ";
                            errMsg += "not recognized:\n";
                            for (j = 0; j < invalidLocations.length; j++) {
                                errMsg += invalidLocations[j] + "\n";
                            }
                            window.alert(errMsg);
                        }
                                              
                        if (numMarkers != 0) {
                            map.fitBounds(bounds);
                        } else  {
                            map.setCenter(new google.maps.LatLng(49.2827,-123.1207));
                            map.setZoom(12);
                        }
                    });
                };

                // Bias the SearchBox results towards places that are within the bounds of the
                // current map's viewport.
                google.maps.event.addListener(map, 'bounds_changed', function() {
                    var bounds = map.getBounds();

                    for (var i = 0; i < inputLocations.length; i++) {
                        inputLocations[i].searchBox.setBounds(bounds);

                    }
                });
            }

            google.maps.event.addDomListener(window, 'load', initialize);

            function deleteClicked(e, number) {
                if (document.getElementById("delete"+number.toString()).disabled) {
                    e.preventDefault();
                    return;
                }
                
                if (confirm('Are you sure you want to delete this marker from the map?'))
                    deleteMarker(number);
                else {
                    e.preventDefault();
                    console.log("cancelled deleting marker # " + number.toString());
                }
            }

            function deleteMarker(number) {
                console.log("removing marker # " + number.toString());
                inputLocations[number-1].marker.setMap(null);
                document.getElementById("locationInput"+number.toString()).value = "";
                shiftLocations(number-1);
            }

            function shiftLocations(index) {
                for (var j = index; j < inputLocations.length-1; j++) {
                    inputLocations[j].searchBox.set('place', inputLocations[j+1].searchBox.getPlace());
                    document.getElementById("locationInput"+(j+1).toString()).value = document.getElementById("locationInput"+(j+2).toString()).value;
                }
                inputLocations[inputLocations.length-1].searchBox.set('place', void(0));
                document.getElementById("locationInput"+inputLocations.length.toString()).value = "";
            }

            function resetClicked(e) {
                if (confirm('Are you sure you want to remove all markers from the map?'))
                removeAllMarkers();
                else {
                    e.preventDefault();
                    console.log("cancelled deleting all markers");
                }
            }

            function removeAllMarkers() {
                console.log("removing all markers");
                for (var i = 0, ip; ip = inputLocations[i]; i++) {
                    ip.marker.setMap(null);
                    document.getElementById("locationInput"+(i+1).toString()).value = "";
                    ip.searchBox.set('place',void(0));
                }
            }

            function calcRoute() {
                // Plotting multiple destinations
                var waypoints = [];
                var startLoc;
                var destLoc;
                for (var i = 0; i < markerArray.length; i++) {
                    markerArray[i].setMap(null);
                }

                markerArray = [];
                for (var i = 1; i <= 5; i++) {
                    var address = document.getElementById("locationInput" + i.toString()).value;
                    if (address !== "") {
                        waypoints.push({
                            location: address,
                            stopover: true
                        });
                    } else {
                        break;
                    }
                }
                var pointsToPassBy = [];
                if (waypoints.length === 0) {
                    alert("Please enter at least one location for route calculation.");
                    return;
                } else if (waypoints.length === 1) {
                    startLoc = waypoints[0].location;
                    destLoc = waypoints[1].location;
                } else {
                    startLoc = waypoints[0].location;
                    destLoc = waypoints[waypoints.length - 1].location;
                    if (waypoints.length > 2) {
                        for (var i = 1; i < waypoints.length; i++) {
                            if (i != waypoints.length-1) {
                                pointsToPassBy.push(waypoints[i]);
                            }
                        }
                        console.log(pointsToPassBy.length);
                        console.log(waypoints.length);
                    }
                }
                // End of plotting multiple destinations
                  var request = {
                      origin: startLoc,
                      destination: destLoc,
                      waypoints: pointsToPassBy,
                      optimizeWaypoints: false,
                      travelMode: google.maps.TravelMode.BICYCLING
                  };
                  directionsService.route(request, function(response, status) {
                    if (status == google.maps.DirectionsStatus.OK) {
                      directionsDisplay.setDirections(response);
                      var plannedRoutes = response.routes;
                      var singleRoute = plannedRoutes[0];
                      var leg = singleRoute.legs[0];
                      var steps = leg.steps;
                      var length = steps.length;
                      alert("There are " + length + " steps in these direction instructions.");
                      showSteps(response);
                    }
                  });
             }

             function attachInstructionText(marker, text) {
              google.maps.event.addListener(marker, 'click', function() {
                stepDisplay.setContent(text);
                stepDisplay.open(map, marker);
              });
            }

            function showSteps(directionResult) {
              for (var k = 0; k < directionResult.routes[0].legs.length; k++) {
                console.log(directionResult.routes[0].legs.length);
                  var myRoute = directionResult.routes[0].legs[k];

                  for (var i = 0; i < myRoute.steps.length; i++) {
                    var marker = new google.maps.Marker({
                      position: myRoute.steps[i].start_location,
                      map: map,
                      icon: 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|00ff00'
                    });
                    attachInstructionText(marker, myRoute.steps[i].instructions);
                    markerArray[i] = marker;
                  }
              }
            }

            function calcRt() {
                var startIndex = document.getElementById("spinner1").value;
                var finIndex = document.getElementById("spinner2").value;
                var startID = "locationInput" + (startIndex).toString();
                var endID = "locationInput" + (finIndex).toString();
                var start = document.getElementById(startID).value;
                var end = document.getElementById(endID).value;
                var request = {
                      origin: start,
                      destination: end,
                      travelMode: google.maps.TravelMode.BICYCLING
                  };
                  directionsService.route(request, function(response, status) {
                    if (status == google.maps.DirectionsStatus.OK) {
                      directionsDisplay.setDirections(response);
                      var plannedRoutes = response.routes;
                      var singleRoute = plannedRoutes[0];
                      var leg = singleRoute.legs[0];
                      var steps = leg.steps;
                      var length = steps.length;
                      alert("There are " + length + " steps in these direction instructions.");
                      markerArray = [];
                      showSteps(response);
                    }
                  });
            }

        </script>
    </head>
    <body>
    <nav>
        <div id='navBar'>
            <ul>
            	<a href="/RoutePlanner/"> <li>Home </li></a> 
            	<a href="/RoutePlanner/about.html"> <li> About </li></a>                     
                {% if user.is_authenticated %}
		        <a href="/RoutePlanner/logout.html"> <li>Log Out</li></a> 
		        <a href="/RoutePlanner/account.html"> <li>My Account</li></a> 
		        {% else %}
		        <a href="/RoutePlanner/login.html"><li>Log In</li></a> 
		        <a href="/RoutePlanner/register.html"><li>Get Started</li></a> 
		        {% endif %}
            </ul>
        </div>
    </nav>
        <div id='title'>
            <h1> Route Planner </h1>
        </div>
        <div id="infoInput">
        </div>
        <div id = "extraData">
            Locations:
            <table id="markerTable"><br/>
                <tr><td><input id="locationInput1" class="controls" type="text" style="background-color:#FFFFFF" placeholder="Location 1"></td>
                    <td><img src="{{ STATIC_URL }}images/redX.png" id="delete1" alt="Delete marker" height="30" width="30" onclick="deleteClicked(event, 1);"></td></tr>
                <tr><td><input id="locationInput2" class="controls" type="text" disabled="true" style="background-color:#CCCCCC" placeholder="Location 2"></td>
                    <td><img src="{{ STATIC_URL }}images/redX.png" id="delete2" alt="Delete marker" height="30" width="30" disabled="true" onclick="deleteClicked(event, 2);"></td></tr>
                <tr><td><input id="locationInput3" class="controls" type="text" disabled="true" style="background-color:#CCCCCC" placeholder="Location 3"></td>
                    <td><img src="{{ STATIC_URL }}images/redX.png" id="delete3" alt="Delete marker" height="30" width="30" disabled="true" onclick="deleteClicked(event, 3);"></td></tr>
                <tr><td><input id="locationInput4" class="controls" type="text" disabled="true" style="background-color:#CCCCCC" placeholder="Location 4"></td>
                    <td><img src="{{ STATIC_URL }}images/redX.png" id="delete4" alt="Delete marker" height="30" width="30" disabled="true" onclick="deleteClicked(event, 4);"></td></tr>
                <tr><td><input id="locationInput5" class="controls" type="text" disabled="true" style="background-color:#CCCCCC" placeholder="Location 5"></td>
                    <td><img src="{{ STATIC_URL }}images/redX.png" id="delete5" alt="Delete marker" height="30" width="30" disabled="true" onclick="deleteClicked(event, 5);"></td></tr>
            </table>
            {% if user.is_authenticated %}
            Logged in as {{ user.username }}<br/>
            {% endif %}
            <br/>
            Last updated: {{ updateTime|safe }}
            <br/>
            {% if user.is_superuser %}
            <form action="#" method="get">
                <input class="submitBtn" type="submit" value="Update Database" name="update"> </input>
            </form>
            {% endif %}
            <button class="submitBtn" type="reset" onclick="resetClicked(event);">Reset Markers</button>
            <br> Please enter the start location.
            <br><input type="number" MIN="1" MAX="5" STEP="1" VALUE="1" SIZE="6" id="spinner1" class="controls"> </input>
            <br> Please enter the end location.
            <br><input type="number" MIN="1" MAX="5" STEP="1" VALUE="5" SIZE="6" id="spinner2" class="controls"> </input>
            <br><button class="submitBtn" type="button" onclick="calcRt();">Plot Routes</button>
            <br><button class="submitBtn" type="button" onclick="calcRoute();">Plot All Routes</button>
        </div>
        <div id="googleMap">
        </div>

    <div id="fb-root"></div>
    <script type="text/javascript">
        window.fbAsyncInit = function() {
            FB.init({
                appId: '800885373358594',
                status: true, 
                cookie: true,
                xfbml: true
            });
        };
        (function() {
            var e = document.createElement('script'); 
            e.async = true;
            e.src = document.location.protocol + '//connect.facebook.net/en_US/all.js';
            document.getElementById('fb-root').appendChild(e);
        }());

        function saveMapToDataUrl() {

            var element = $("#mapDiv");

            html2canvas(element, {
                useCORS: true,
                onrendered: function(canvas) {
                    var dataUrl= canvas.toDataURL("image/png");
                    console.log(dataUrl);
                    // TODO: DO SOMETHING WITH THE DATAURL
                    // Eg. write it to the page

                    $(document).ready(function(){
                        $('#share_button').click(function(e){
                            e.preventDefault();
                            FB.ui({
                                method: 'feed',
                                name: 'This is the content of the "name" field.',
                                link: 'http://127.0.0.1:8000/RoutePlanner/',
                                picture: 'dataUrl',
                                caption: 'This is the content of the "caption" field.',
                                description: 'This is the content of the "description" field, below the caption.',
                                message: ''
                            });
                        });
                    });
                    document.write('<img src="' + dataUrl + '"/>');
                }
            });
        }

    </script>

    <div
      class="fb-like"
      data-share="true"
      data-width="450"
      data-show-faces="true">
    </div>

    </body>
    
</html>
